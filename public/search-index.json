[{"slug":"introducing-astro","category":"blog","title":"How to build a real-time movie voting system using React.js ðŸ¤¯","description":"We're excited to announce Astro as a new way to build static websites and deliver lightning-fast performance without sacrificing a modern developer experience.","tags":["astro"],"body":"\n## What we'll be building?\n\nFirst we'll try to build a simple(not so simple actually) movie review app. Where users can vote on movies, write comments and may be add movies too.\n\nThen in the second part we can go deeper by adding a booking system to the movies and have multiple theaters. We'll be using [Rocketgraph](https://rocketgraph.io/) to do this as it provides a complete backend with auth ad db so we don't have to worry about that.\n\nFor this you'll need to define users, movies and a place to store them:\n1. Authentication: You need to store users in a table on say a Postgres DB.\n\n2. Realtime: You need to get realtime comments, and likes from the DB straight to your frontend for the user.\n\n3. A Database: Where you can map users to movies and users and movies to likes.\n\n> ðŸ’¡To read this article you need to have a basic understanding of React.js\n\n\n## [Rocketgraph](https://rocketgraph.io/) : A complete backend that beats Firebase and is open-source\nA little background. Rocketgraph provides a complete backend. It comes with a Postgres DB, Hasura console to manage your Postgres and add GraphQL layer to your data, Authentication and Serverless functions. \n\nSo to sum it up we provide auth for your web apps, GraphQL for realtime things like messages/notifications/comments etc and Serverless functions for anything you want to offload. Our Serverless Github app auto-compiles your Github code to AWS Lambda functions.\n\n## So what the hack is GraphQL?\nGraphQL is a language specification by Meta to achieve realtime queries on your data by asking for exactly what you need. This is different from traditional API approach where the query is coded into the backend and front-end has very little control over what/how to ask for data.\n\nThink of it like a JSON query. You ask for what data you want inn a json-like query and it will return exactly those fields. \n\nIn this article we'll leverage the power of GraphQL, React Apollo and Hasura to build a real-time system for rating and commenting on movies. We can use this same system to book movie tickets too.\n\n## TLDR Version\n\nIf you just want to see the code. Here is the [code base for this article](https://github.com/RocketsGraphQL/rgraph/tree/master/example-setups/movie-voting). Here you can see [more examples](https://github.com/RocketsGraphQL/rgraph/tree/master/example-setups). This is the [open-source software](https://github.com/RocketsGraphQL/hasura-batteries) behind Rocketgraph\n\nKeep reading\n\n![keep reading gif](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/yma0zrp48i934bppq3pc.jpeg)\n\n## Cool, let's start from the basics\nCreate a react project and develop the front-end. Forget about the backend, we'll add it later.\n\n\n```bash\nmkdir movie-voting\ncd movie-voting\n```\n\nNext scaffold a basic react application.\n\n```bash\nnpx create-react-app ./\n```\n\nInstall [react router](https://www.npmjs.com/package/react-router-dom) to be able to navigate between pages. Install react-apollo and graphql for real-time stuff as mentioned above.\n\n```bash\nyarn add react-router-dom\nyarn add @apollo/client graphql\n```\n\nDelete the redundant files such as logo from the project and update the index.js file to as follows:\n\n```javascript\n// src/index.js\nimport React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport { BrowserRouter as Router, Routes, Route } from \"react-router-dom\";\nimport App from \"./App\";\n\nReactDOM.render(\n  <React.StrictMode>\n      <Router>\n          <Routes>\n            <Route path=\"/login\" />\n            <Route path=\"/signup\" />\n            <Route path=\"/\" element={<App />} />\n          </Routes>\n      </Router>\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n```\n\nNow we need to add the App.js and login/signup components. Thats easy.\n\nApp.js\n\n```javascript\nimport logo from './logo.svg';\nimport './App.css';\n\n\nconst movies = [\n  {\n    name: 'Snatch',\n    img: 'https://occ-0-3934-3211.1.nflxso.net/dnm/api/v6/E8vDc_W8CLv7-yMQu8KMEC7Rrr8/AAAABVJgO06RKuruJpcyezdM43Ai2ZjvNDmtbnwUXVtvXVhhvpL0tvhr4s9e3j8UojFCLao5a7v8Dg5kti1vFKcA0ldZXWnnC03nBRIt.jpg?r=cbf',\n    likes: 10,\n    state: true,\n  }\n];\n\nfunction App() {\n  return (\n    <div className=\"App\">\n      <header className=\"App-header\">\n        <p>\n          Movies list\n        </p>\n      </header>\n      {\n        movies.map(movie => {\n          return (\n              <div className=\"movie-box\">\n                <div className=\"movie-box-header\">\n                </div>\n                <div className=\"movie-box-body\">\n                  <img alt={movie.name} className=\"movie-image\" src={movie.img} />\n                </div>\n                <div className=\"movie-box-footer\">\n                  {movie.name}\n                  <div className=\"like-button\"><i class=\"fa fa-heart\" style={{\"color\": \"red\"}}aria-hidden=\"true\"></i></div>\n                </div>\n              </div>\n          )\n        })\n      }\n    </div>\n  );\n}\n\nexport default App;\n\n```\n\nNow we have the basic home page design. Let's create the login and signup pages.\n\nsignup.js\n\n```javascript\nimport React, { useState } from \"react\";\nimport { useNavigate } from 'react-router-dom';\n\nexport default function Login(props) {\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const navigate = useNavigate();\n\n  async function handleSubmit(e) {\n    e.preventDefault();\n    navigate(\"/\");\n  }\n\n  return (\n    <div>\n      <h1>Signup</h1>\n      <form onSubmit={handleSubmit}>\n        <input\n          type=\"email\"\n          placeholder=\"email\"\n          value={email}\n          onChange={(e) => setEmail(e.target.value)}\n        />\n        <input\n          type=\"password\"\n          placeholder=\"password\"\n          value={password}\n          onChange={(e) => setPassword(e.target.value)}\n        />\n        <button>Signup</button>\n      </form>\n    </div>\n  );\n}\n```\n\nLet's see if that worked\n\n```\nyarn start\n```\n\nCongratulationsðŸ¥‚, you just created the skeleton for the web application. Now we just have to fill in the data, auth and realtime.\n\nEnter [Rocketgraph](https://rocketgraph.io/). How to create a backend with authentication and serverless functions.\n\n\nJust signup and click on create a project in the dashboard:\n\n![create project](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/e56z6jzw1xdw18lxo3vi.png)\n\nNext we'll learn about some amazing features that will magically build the backend for you with the power of GraphQL.\n\nOnce your project is up, you get a Hasura console and a Postgres DB as shown below. Please wait for the services to boot up. It might take about 3-5 minutes.\n\n\n## What is Hasura?\n\nHasura is an amazing open-source tool that GraphQLises your postgres database. What it means is that your data is still in the postgres db but you get the powers of GraphQL. It also has an editor which automatically generates GraphQL queries based on your Postgres Tables.\n\n## Back to Rocketgraph\n\nWhen your project is booted up, you get a Hasura link here:\n\n![link to hasura](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/u4vvwszw74ucjrxicp06.png)\n\nOpen Hasura, and now we ca start creating tables for our Database.\n\nWe need a Movies table as shown below:\n\n![movies table](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5ptf6yxtwix1wxebvqlr.png)\n\nWe also need to let the users access it. In Rocketgraph `user` is a role that is authenticated and our JS SDKs send in the JWT with your requests so you don't have to.\n\nGo to the permissions tab on the movies and add the following permissions:\n\nFor insert put permissions as follows:\n\n\n![insert 1](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2gga01ng0071izvr4yoe.png)\n\n![insert 2](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/480wrcehyi97rgyj5lbz.png)\n\nAnd for select, it's the same:\n\n![select](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y4oxfy4ayexp73k740ci.png)\n\nEnter GraphQL using react-apollo and graphql packages. Apollo makes it easier to query your GraphQL directly from React and provides some powerful functionality like `useSubscription` which we will discuss later.\n\nLet's install them.\n\n```\nyarn add @apollo/client graphql\n```\n\nWe'll also need some custom made JS libraries to get authentication to work.\n\n```\nyarn add @rocketgraphql/react-apollo @rocketgraphql/rocketgraph-js-sdk\n```\n\n\nNow we will add auth to our code using the `RApolloProvider` provided by `@rocketgraphql/react-apollo`\n\nFirst create a folder named `utils` and then create `config.js` inside it with the following content:\n\n```javascript\nimport { createClient } from \"@rocketgraphql/rocketgraph-js-sdk\";\nimport Cookies from 'js-cookie';\n\nconst config = {\n  baseURL: \"https://backend-REPLACE\",\n};\n\nconst { auth } = createClient(config);\n\nexport { auth };\n\n```\n\nReplace the above `https://backend-REPLACE` with the backend url in your Rocketgraph dashboard:\n\n\n![backend url](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/awi1dshzvd155ua3dlsj.png)\n\nYou'll find it in the `Auth` section.\n\n\nChange the code in `index.js` to:\n\n```javascript\n// src/index.js\nimport React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport { BrowserRouter as Router, Routes, Route } from \"react-router-dom\";\nimport App from \"./App\";\nimport Signup from \"./components/login\";\nimport { RApolloProvider } from \"@rocketgraphql/react-apollo\";\nimport { auth } from \"./utils/config\";\n\nReactDOM.render(\n  <React.StrictMode>\n      <RApolloProvider auth={auth} gqlEndpoint=\"https://gqlEndpoint/v1/graphql\">\n        <Router>\n            <Routes>\n              <Route path=\"/login\" element={<Signup />}/>\n              <Route path=\"/signup\" />\n              <Route path=\"/\" element={<App />} />\n            </Routes>\n        </Router>\n      </RApolloProvider>\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n\n```\n\nChange the above `https://gqlEndpoint/v1/graphql` to the graphql endpoint you have here in your Hasura console:\n\n\n![gqlendpoint](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/du5j4bl3rmrvph2r5p96.png)\n\nNext we'll add auth.\n\n`login.js`\n\n```javascript\nimport React, { useState } from \"react\";\nimport { useNavigate } from 'react-router-dom';\nimport { auth } from \"../utils/config\";\n\nexport default function Login(props) {\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const navigate = useNavigate();\n\n  async function handleSubmit(e) {\n    e.preventDefault();\n\n    // login\n    try {\n      await auth.signIn({email, password, provider: \"local\"});\n    } catch (error) {\n      alert(\"error logging in\");\n      console.error(error);\n      return;\n    }\n\n    navigate(\"/\");\n  }\n\n  return (\n    <div>\n      <h1>Login</h1>\n      <form onSubmit={handleSubmit}>\n        <input\n          type=\"email\"\n          placeholder=\"email\"\n          value={email}\n          onChange={(e) => setEmail(e.target.value)}\n        />\n        <input\n          type=\"password\"\n          placeholder=\"password\"\n          value={password}\n          onChange={(e) => setPassword(e.target.value)}\n        />\n        <button>Login</button>\n      </form>\n    </div>\n  );\n}\n```\n\n`signup.js`\n\n```javascript\nimport React, { useState } from \"react\";\nimport { useNavigate } from 'react-router-dom';\nimport { auth } from \"../utils/config\";\n\n\nexport default function Login(props) {\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const navigate = useNavigate();\n\n  async function handleSubmit(e) {\n    e.preventDefault();\n\n    // login\n    try {\n      await auth.register({email, password});\n    } catch (error) {\n      alert(\"error logging in\");\n      console.error(error);\n      return;\n    }\n\n    navigate(\"/\");\n  }\n\n  return (\n    <div>\n      <h1>Signup</h1>\n      <form onSubmit={handleSubmit}>\n        <input\n          type=\"email\"\n          placeholder=\"email\"\n          value={email}\n          onChange={(e) => setEmail(e.target.value)}\n        />\n        <input\n          type=\"password\"\n          placeholder=\"password\"\n          value={password}\n          onChange={(e) => setPassword(e.target.value)}\n        />\n        <button>Login</button>\n      </form>\n    </div>\n  );\n}\n```\n\nThat's it. Rocketgraph will do the rest. Users will be populated in the user database.\n\n\n![TJ](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mlmogzb86hkm40l0xkme.gif)\n\nYou can test this by signing up and checking that the user is created.\n\n## Let's build more features\n\nEnter react-apollo.\n\n`App.js`\n\n```javascript\nimport './App.css';\nimport { gql, useSubscription } from \"@apollo/client\";\n\nconst GET_MOVIES = gql`\n  subscription {\n    movies {\n      id\n      created_at\n      name\n      image\n    }\n  }\n`;\n\nfunction App() {\n  const { data, loading } = useSubscription(GET_MOVIES);\n  if (loading) {\n    return <div>Loading</div>;\n  }\n  return (\n    <div className=\"App\">\n      <header className=\"App-header\">\n        <p>\n          Movies list\n        </p>\n      </header>\n      {\n        data && data.movies && data.movies.length ?\n        data.movies.map((movie, index) => {\n          return (\n              <div className=\"movie-box\" key={index}>\n                <div className=\"movie-box-header\">\n                </div>\n                <div className=\"movie-box-body\">\n                  <img alt={movie.name} className=\"movie-image\" src={movie.image} />\n                </div>\n                <div className=\"movie-box-footer\">\n                  {movie.name}\n                  <div className=\"like-button\"><i className=\"fa fa-heart\" style={{\"color\": \"red\"}} aria-hidden=\"true\"></i></div>\n                </div>\n              </div>\n          )\n        }) : \"No movies\"\n      }\n    </div>\n  );\n}\n\nexport default App;\n```\n\nThat's it, just add records in your db and you can see it here in realtime.\n\nAwesome ðŸ˜Ž Now finally let's add the like button\n\n## Important part (User-Id)\n\nFirst create likes table with id, movie_id and user_id as shown below in Hasura\n\n\n![create likes table](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/33bzwwrn78zl471yptc5.png)\n\nWe will have to extract this User-Id from the jwt token itself.\nTo do that\n\n\n### Step 1\nCreate a new role named `user` and click on `Insert` to edit it's permissions\n\n![permissions step 1](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/gbwv3esplq1rtz7bc2p3.png)\n\n### Step 2\nAllow user role to modify all. Check these boxes\n\n\n![modify](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/53o1ly3uc47u0kajpvi6.png)\n\n### Step 3 - most important\nSet the user-id automatically\n\nClick on column presets and select user-id. Set from X-Hasura-user-id.\n\n\n![session](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wn6peijcpotb16m5tsqf.png)\n\nAnd click save. Now we have prepared our table to hold the likes/votes\n\n\n## Enter Aggregations (Likes)\n\n\nCreate a new file in `components` named\n`likeCount.js`\n\n```javascript\nimport React, { useState } from \"react\";\nimport { gql, useSubscription, useMutation } from \"@apollo/client\";\n\nconst likes = (movie_id) => gql`\n  subscription {\n    likes(where: {movie_id: {_eq: \"${movie_id}\"}}) {\n        id\n        user_id\n    }\n  }\n`;\n\nconst LIKE = gql`\n  mutation like($movie_id: uuid!) {\n    insert_likes(objects: {movie_id: $movie_id}) {\n        affected_rows\n    }\n  }\n`;\n\nconst UNLIKE = gql`\n    mutation unlike($movie_id: uuid!) {\n        delete_likes(where: {movie_id: {_eq: $movie_id}}) {\n            affected_rows\n        }\n    }\n`;\n\nfunction Component({movie}) {\n  const LIKE_COUNT = likes(movie.id);\n  const [addLike, { like_data, like_loading, error }] = useMutation(LIKE);\n  const [unLike, _] = useMutation(UNLIKE);\n\n  const [isRed, setIsRed] = useState(false);\n  const { data, loading } = useSubscription(LIKE_COUNT);\n  console.log(data, movie);\n  if (loading) {\n    return <div>Loading</div>;\n  }\n  const likeThis = () => {\n    setIsRed(!isRed);\n    if (isRed) {\n        unLike({variables: {movie_id: movie.id}});\n    } else {\n        addLike({ variables: { movie_id: movie.id }});\n    }\n  }\n  return (\n    <span>\n        {data.likes.length}\n        <i className=\"fa fa-heart\" style={{\"color\": isRed ? \"red\" : \"gray\"}} aria-hidden=\"true\" onClick={likeThis}></i>\n    </span>\n  );\n}\n\nexport default Component;\n\n```\n\nOh wait! That would delete all likes in the table. So let's secure our table by:\n\n\n![delete permission](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5cyfvrl2dopsn3wbrswi.png)\n\nAnd import this into `App.js` like this:\n\n```javascript\nimport './App.css';\nimport { gql, useSubscription } from \"@apollo/client\";\nimport LikeCountComponent from \"./components/likeCount\";\n\nconst GET_MOVIES = gql`\n  subscription {\n    movies {\n      id\n      created_at\n      name\n      image\n    }\n  }\n`;\n\n\n\nfunction App() {\n  const { data, loading } = useSubscription(GET_MOVIES);\n  if (loading) {\n    return <div>Loading</div>;\n  }\n  return (\n    <div className=\"App\">\n      <header className=\"App-header\">\n        <p>\n          Movies list\n        </p>\n      </header>\n      {\n        data && data.movies && data.movies.length ?\n        data.movies.map((movie, index) => {\n          return (\n              <div className=\"movie-box\" key={index}>\n                <div className=\"movie-box-header\">\n                </div>\n                <div className=\"movie-box-body\">\n                  <img alt={movie.name} className=\"movie-image\" src={movie.image} />\n                </div>\n                <div className=\"movie-box-footer\">\n                  {movie.name}\n                  <div className=\"like-button\"><LikeCountComponent movie={movie} /></div>\n                </div>\n              </div>\n          )\n        }) : \"No movies\"\n      }\n    </div>\n  );\n}\n\nexport default App;\n```\n\n\nThat's a wrap! Congrats, you just made a movie voting app.\n\n\n![bye gif](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/lp70xycptv3i68t03ybr.gif)\n"}]